<script>
    // --- DOM Elements ---
    const allModeButtons = document.querySelectorAll('.mode-button');
    const scannerView = document.getElementById('scannerView');
    const cameraStream = document.getElementById('cameraStream');
    const pastedImage = document.getElementById('pastedImage');
    const capturedImage = document.getElementById('capturedImage');
    const placeholderText = document.getElementById('placeholderText');
    const placeholderIcon = document.getElementById('placeholderIcon');
    const dragDropText = document.getElementById('dragDropText');
    const pasteError = document.getElementById('pasteError');
    const uploadFileInput = document.getElementById('uploadFileInput');
    const uploadButton = document.getElementById('uploadButton');
    const analyzeButton = document.getElementById('analyzeButton');
    const resultPlaceholder = document.getElementById('resultPlaceholder');
    const analysisLoader = document.getElementById('analysisLoader');
    const resultData = document.getElementById('resultData');
    const progressBar = document.getElementById('progressBar');
    const loaderStatusText = document.getElementById('loaderStatusText');
    const detailsButton = document.getElementById('detailsButton');
    const scanAgainButton = document.getElementById('scanAgainButton');
    const detailsModal = document.getElementById('detailsModal');
    const closeModalButton = document.getElementById('closeModalButton');
    const dropArea = document.getElementById('dropArea');
    
    let currentImageFile = null;
    let activeStream = null;
    let currentMode = '';

    // --- CORE FUNCTIONS ---
    function setInputMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        resetInputState();
        const activeBtn = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        activeBtn.classList.add('active');
        switch (mode) {
            case 'capture':
                placeholderText.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
                placeholderIcon.innerText = 'üì∏';
                dragDropText.classList.add('hidden');
                analyzeButton.classList.remove('hidden');
                analyzeButton.innerText = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
                startCamera();
                break;
            case 'upload':
                placeholderText.innerText = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
                placeholderIcon.innerText = '‚òÅÔ∏è';
                dragDropText.classList.remove('hidden');
                uploadButton.classList.remove('hidden');
                break;
            case 'paste':
                placeholderText.innerText = '‡∏Å‡∏î Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                placeholderIcon.innerText = 'üìã';
                dragDropText.classList.add('hidden');
                break;
        }
    }

    function resetInputState() {
        allModeButtons.forEach(btn => btn.classList.remove('active'));
        [pastedImage, capturedImage, cameraStream, uploadButton, analyzeButton].forEach(el => el.classList.add('hidden'));
        scannerView.classList.remove('active-camera', 'has-image', 'drag-over');
        scannerView.querySelector('.placeholder').classList.remove('hidden');
        analyzeButton.disabled = true;
        pastedImage.src = ''; 
        capturedImage.src = '';
        currentImageFile = null;
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }
        resultData.classList.add('hidden');
        analysisLoader.classList.add('hidden');
        resultPlaceholder.classList.remove('hidden');
    }

    function startCamera() {
         navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                activeStream = stream;
                cameraStream.srcObject = stream;
                scannerView.classList.add('active-camera');
                analyzeButton.disabled = false;
            })
            .catch(err => {
                showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå");
                setInputMode('upload');
            });
    }
    
    function processImageForAnalysis(file) {
        if (!file || !file.type.startsWith('image/')) {
            showError("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            return;
        }
        currentImageFile = file;
        const imageUrl = URL.createObjectURL(file);
        pastedImage.src = imageUrl;
        scannerView.classList.add('has-image');
        analyzeButton.classList.remove('hidden');
        analyzeButton.disabled = false;
        analyzeButton.innerText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
    }

    async function startRealAnalysis(imageFile) {
        analyzeButton.disabled = true;
        analyzeButton.innerHTML = '<div class="spinner"></div><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>';
        resultPlaceholder.classList.add('hidden');
        resultData.classList.add('hidden');
        analysisLoader.classList.remove('hidden');
        const formData = new FormData();
        formData.append('foodImage', imageFile);

        progressBar.style.width = '25%';
        loaderStatusText.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á AI...';

        try {
            // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏Å‡πâ URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Render ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**
            const backendUrl = 'https://cal-track-backend.onrender.com/analyze'; // <-- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            const response = await fetch(backendUrl, {
                method: 'POST', body: formData,
            });
            
            progressBar.style.width = '75%';
            loaderStatusText.innerText = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

            const result = await response.json();

            await new Promise(resolve => setTimeout(resolve, 1000));
            progressBar.style.width = '100%';
            
            if (response.ok && result.success) {
                loaderStatusText.innerText = `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ${result.name}!`;
                await new Promise(resolve => setTimeout(resolve, 500));
                displayResults(result);
            } else {
                throw new Error(result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ");
            }
        } catch (error) {
            console.error("Analysis Error:", error);
            showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message);
        }
    }
    
    function displayResults(data) {
        analysisLoader.classList.add('hidden');
        document.getElementById('foodImage').src = data.imageSrc;
        document.getElementById('foodName').innerText = data.name;
        document.getElementById('calories').innerText = data.calories;
        document.getElementById('protein').innerText = data.protein;
        document.getElementById('carbs').innerText = data.carbs;
        document.getElementById('fat').innerText = data.fat;
        resultData.classList.remove('hidden');
    }

    function showError(title, message) {
        analysisLoader.classList.add('hidden');
        resultPlaceholder.classList.remove('hidden');
        alert(`${title}\n${message}`);
        resetInputState();
        setInputMode(currentMode || 'upload');
    }

    // --- EVENT LISTENERS ---
    allModeButtons.forEach(button => {
        button.addEventListener('click', () => setInputMode(button.id.replace('mode', '').toLowerCase()));
    });
    scannerView.addEventListener('click', () => { if (currentMode === 'upload' && !scannerView.classList.contains('has-image')) { uploadFileInput.click(); } });
    uploadButton.addEventListener('click', () => uploadFileInput.click());
    uploadFileInput.addEventListener('change', (event) => { if (event.target.files.length > 0) { processImageForAnalysis(event.target.files[0]); } });
    
    analyzeButton.addEventListener('click', () => {
         if (currentMode === 'capture') {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth; canvas.height = cameraStream.videoHeight;
            const context = canvas.getContext('2d');
            context.translate(canvas.width, 0); context.scale(-1, 1);
            context.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(file => {
                if(file) startRealAnalysis(file)
            }, 'image/jpeg', 0.95);
        } else if (currentImageFile) {
            startRealAnalysis(currentImageFile);
        }
    });

    scanAgainButton.addEventListener('click', () => {
        resetInputState();
        setInputMode(currentMode);
    });
    
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); if (currentMode === 'upload') { scannerView.classList.add('drag-over'); } });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); scannerView.classList.remove('drag-over'); });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault(); scannerView.classList.remove('drag-over');
        if (currentMode !== 'upload') return;
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) { processImageForAnalysis(files[0]); }
        else { showError("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); }
    });

    document.addEventListener('paste', (e) => {
        if (currentMode !== 'paste') return;
        const items = (e.clipboardData || window.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                const imageFile = item.getAsFile();
                processImageForAnalysis(imageFile);
                return;
            }
        }
         showError("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Clipboard"); e.preventDefault();
    });
    
    // Initial setup
    setInputMode('upload');
</script>