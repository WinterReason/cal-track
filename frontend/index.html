<script>
    // --- DOM Elements ---
    const allModeButtons = document.querySelectorAll('.mode-button');
    const scannerView = document.getElementById('scannerView');
    const cameraStream = document.getElementById('cameraStream');
    const pastedImage = document.getElementById('pastedImage');
    const capturedImage = document.getElementById('capturedImage'); // ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    const placeholderText = document.getElementById('placeholderText');
    const placeholderIcon = document.getElementById('placeholderIcon');
    const dragDropText = document.getElementById('dragDropText');
    const uploadFileInput = document.getElementById('uploadFileInput');
    const uploadButton = document.getElementById('uploadButton');
    const analyzeButton = document.getElementById('analyzeButton');
    const resultPlaceholder = document.getElementById('resultPlaceholder');
    const analysisLoader = document.getElementById('analysisLoader');
    const resultData = document.getElementById('resultData');
    const progressBar = document.getElementById('progressBar');
    const loaderStatusText = document.getElementById('loaderStatusText');
    const scanAgainButton = document.getElementById('scanAgainButton');
    const detailsButton = document.getElementById('detailsButton'); // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Modal ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
    const dropArea = document.getElementById('dropArea');
    const pasteError = document.getElementById('pasteError'); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£ Paste

    let currentImageFile = null;
    let activeStream = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö stream ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á
    let currentMode = ''; // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    let isAnalyzing = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î Analyze ‡∏ã‡πâ‡∏≥

    // ** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏Å‡πâ URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Backend Render ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
    const BACKEND_API_URL = 'https://cal-track-backend.onrender.com/analyze'; // <-- ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

    // --- CORE FUNCTIONS ---

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î Input
    function setInputMode(mode) {
        if (isAnalyzing) return; // ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        if (currentMode === mode) return; // ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°

        currentMode = mode; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        
        // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        resetUIAndState();

        // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î "Active"
        allModeButtons.forEach(btn => btn.classList.remove('active'));
        const activeBtnElement = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        if (activeBtnElement) {
            activeBtnElement.classList.add('active');
        }

        // 3. ‡∏õ‡∏£‡∏±‡∏ö UI ‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        switch (mode) {
            case 'capture':
                placeholderText.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
                placeholderIcon.innerText = 'üì∏';
                dragDropText.classList.add('hidden');
                uploadButton.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                analyzeButton.classList.remove('hidden');
                analyzeButton.innerText = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
                startCamera();
                break;
            case 'upload':
                placeholderText.innerText = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
                placeholderIcon.innerText = '‚òÅÔ∏è';
                dragDropText.classList.remove('hidden');
                uploadButton.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                analyzeButton.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
                break;
            case 'paste':
                placeholderText.innerText = '‡∏Å‡∏î Ctrl+V ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                placeholderIcon.innerText = 'üìã';
                dragDropText.classList.add('hidden');
                uploadButton.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                analyzeButton.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
                break;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï UI ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function resetUIAndState() {
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö Input ‡πÅ‡∏•‡∏∞ Result
        [pastedImage, cameraStream, uploadButton, analyzeButton].forEach(el => el.classList.add('hidden'));
        scannerView.classList.remove('active-camera', 'has-image', 'drag-over', 'error');
        scannerView.querySelector('.placeholder').classList.remove('hidden');
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        isAnalyzing = false;
        analyzeButton.disabled = true;
        analyzeButton.innerHTML = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
        pastedImage.src = '';
        currentImageFile = null;

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        resultData.classList.add('hidden');
        analysisLoader.classList.add('hidden');
        resultPlaceholder.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á placeholder ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        
        // ‡∏ã‡πà‡∏≠‡∏ô error paste ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        pasteError.classList.remove('visible');
    }

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                activeStream = stream;
                cameraStream.srcObject = stream;
                cameraStream.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á video stream
                scannerView.classList.add('active-camera');
                analyzeButton.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"
            })
            .catch(err => {
                console.error("Error accessing camera:", err);
                showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ", "‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
                setInputMode('upload'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
            });
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ß‡∏≤‡∏á/‡∏ñ‡πà‡∏≤‡∏¢ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview
    function previewImage(file) {
        if (!file || !file.type.startsWith('image/')) {
            showError("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            return;
        }
        currentImageFile = file;
        const imageUrl = URL.createObjectURL(file);
        pastedImage.src = imageUrl;
        pastedImage.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û preview
        scannerView.classList.add('has-image');
        scannerView.querySelector('.placeholder').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô placeholder
        
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        analyzeButton.classList.remove('hidden');
        analyzeButton.disabled = false;
        analyzeButton.innerText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î capture
        if (currentMode === 'capture' && activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
            activeStream = null;
            cameraStream.srcObject = null;
            scannerView.classList.remove('active-camera');
        }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏£‡∏¥‡∏á
    async function startRealAnalysis(imageFile) {
        if (!imageFile || isAnalyzing) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ã‡πâ‡∏≥
        isAnalyzing = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå

        analyzeButton.disabled = true;
        analyzeButton.innerHTML = '<div class="spinner"></div><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>';
        
        resultPlaceholder.classList.add('hidden');
        resultData.classList.add('hidden');
        analysisLoader.classList.remove('hidden');

        progressBar.style.width = '0%';
        loaderStatusText.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á AI...';

        const formData = new FormData();
        formData.append('foodImage', imageFile);

        try {
            const response = await fetch(BACKEND_API_URL, {
                method: 'POST', body: formData,
            });
            
            progressBar.style.width = '50%';
            loaderStatusText.innerText = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

            const result = await response.json();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö HTTP status code ‡∏î‡πâ‡∏ß‡∏¢
            if (!response.ok) {
                throw new Error(result.message || `Backend Error: ${response.status}`);
            }
            
            progressBar.style.width = '100%';
            
            if (result.success) {
                loaderStatusText.innerText = `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: ${result.name}!`;
                await new Promise(resolve => setTimeout(resolve, 500)); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
                displayResults(result);
            } else {
                throw new Error(result.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ");
            }
        } catch (error) {
            console.error("Analysis Error:", error);
            showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message);
        } finally {
            isAnalyzing = false; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ö‡∏ô UI
    function displayResults(data) {
        analysisLoader.classList.add('hidden');
        document.getElementById('foodImage').src = data.imageSrc;
        document.getElementById('foodName').innerText = data.name;
        document.getElementById('calories').innerText = data.calories;
        document.getElementById('protein').innerText = data.protein;
        document.getElementById('carbs').innerText = data.carbs;
        document.getElementById('fat').innerText = data.fat;
        
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
        // detailsButton.onclick = () => openDetailsModal(data); 

        resultData.classList.remove('hidden');
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á scannerView (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö paste error)
    function showPasteError(message) {
        pasteError.innerText = message;
        pasteError.classList.add('visible');
        setTimeout(() => {
            pasteError.classList.remove('visible');
        }, 3000);
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÅ‡∏ö‡∏ö Alert
    function showError(title, message) {
        analysisLoader.classList.add('hidden');
        resultPlaceholder.classList.remove('hidden');
        alert(`${title}\n${message}`);
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á
        resetUIAndState();
        setInputMode(currentMode || 'upload');
    }

    // --- EVENT LISTENERS ---

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î
    allModeButtons.forEach(button => {
        button.addEventListener('click', () => setInputMode(button.id.replace('mode', '').toLowerCase()));
    });

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Scanner View ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î File Explorer (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)
    scannerView.addEventListener('click', () => { 
        if (currentMode === 'upload' && !scannerView.classList.contains('has-image') && !isAnalyzing) { 
            uploadFileInput.click(); 
        } 
    });

    // ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
    uploadButton.addEventListener('click', () => { 
        if (!isAnalyzing) uploadFileInput.click(); 
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å File Explorer
    uploadFileInput.addEventListener('change', (event) => { 
        if (event.target.files.length > 0) { 
            previewImage(event.target.files[0]); 
        } 
    });
    
    // ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"
    analyzeButton.addEventListener('click', () => {
        if (isAnalyzing) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏Ç‡∏ì‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        if (currentMode === 'capture') {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth; 
            canvas.height = cameraStream.videoHeight;
            const context = canvas.getContext('2d');
            
            // Mirror the camera image
            context.translate(canvas.width, 0); 
            context.scale(-1, 1);
            
            context.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(file => {
                if(file) startRealAnalysis(file)
            }, 'image/jpeg', 0.95); // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô JPEG ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 95%
        } else if (currentImageFile) {
            startRealAnalysis(currentImageFile);
        }
    });

    // ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà"
    scanAgainButton.addEventListener('click', () => {
        if (isAnalyzing) return;
        resetUIAndState();
        setInputMode(currentMode); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°
    });
    
    // Drag & Drop
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); if (currentMode === 'upload' && !isAnalyzing) { scannerView.classList.add('drag-over'); } });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); scannerView.classList.remove('drag-over'); });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault(); scannerView.classList.remove('drag-over');
        if (currentMode !== 'upload' || isAnalyzing) return;
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) { previewImage(files[0]); }
        else { showPasteError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); } // ‡πÉ‡∏ä‡πâ showPasteError ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Drag/Drop
    });

    // Paste ‡∏à‡∏≤‡∏Å Clipboard
    document.addEventListener('paste', (e) => {
        if (currentMode !== 'paste' || isAnalyzing) return;
        const items = (e.clipboardData || window.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                const imageFile = item.getAsFile();
                if (imageFile) {
                    previewImage(imageFile); // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á
                    analyzeButton.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                    analyzeButton.disabled = false;
                    analyzeButton.innerText = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå';
                } else {
                    showPasteError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Clipboard");
                }
                return;
            }
        }
        showPasteError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Clipboard"); // ‡πÉ‡∏ä‡πâ showPasteError ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Paste
        e.preventDefault();
    });
    
    // Initial setup
    setInputMode('upload');
</script>